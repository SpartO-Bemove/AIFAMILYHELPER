// db_schema.prisma (draft)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum FamilyRole {
  PARENT
  CHILD
  GRANDPARENT
  OTHER
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TaskType {
  GENERAL
  HOME
  WORK
  KID
  SHOPPING
}

enum ShoppingCategory {
  GROCERIES
  PHARMACY
  KIDS
  HOME
  OTHER
}

enum HomeTaskFrequency {
  ONE_TIME
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum ExpenseCategory {
  GROCERIES
  HOUSING
  UTILITIES
  KIDS
  HEALTH
  TRANSPORT
  ENTERTAINMENT
  OTHER
}

enum Currency {
  RUB
  USD
  EUR
}

model User {
  id              String         @id @default(cuid())
  email           String         @unique
  passwordHash    String
  firstName       String?
  lastName        String?
  locale          String?        // "ru-RU" и т.п.
  timeZone        String?        // "Europe/Moscow"
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  familyMemberships FamilyMember[]
  tasksAssigned     Task[]       @relation("TaskAssignee")
  tasksCreated      Task[]       @relation("TaskCreator")
  eventsCreated     CalendarEvent[] @relation("EventCreator")
  homeTasksAssigned HomeTask[]   @relation("HomeTaskAssignee")
  expensesCreated   Expense[]    @relation("ExpenseCreator")
}

model Family {
  id           String          @id @default(cuid())
  name         String
  defaultCurrency Currency     @default(RUB)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  members      FamilyMember[]
  kids         Kid[]
  events       CalendarEvent[]
  tasks        Task[]
  shoppingItems ShoppingItem[]
  homeTasks    HomeTask[]
  budgets      Budget[]
  expenses     Expense[]
}

model FamilyMember {
  id        String     @id @default(cuid())
  familyId  String
  userId    String?
  role      FamilyRole @default(PARENT)
  displayName String?

  family    Family     @relation(fields: [familyId], references: [id])
  user      User?      @relation(fields: [userId], references: [id])

  @@unique([familyId, userId])
}

model Kid {
  id          String   @id @default(cuid())
  familyId    String
  firstName   String
  lastName    String?
  birthDate   DateTime?
  allergies   String?  // JSON/текст
  medicalNotes String?
  routineJson String?  // JSON-схема режима дня

  family      Family   @relation(fields: [familyId], references: [id])
  events      CalendarEvent[]
  shoppingItems ShoppingItem[]
  expenses    Expense[]
}

model CalendarEvent {
  id          String   @id @default(cuid())
  familyId    String
  title       String
  description String?
  start       DateTime
  end         DateTime
  allDay      Boolean  @default(false)
  location    String?
  kidId       String?
  createdById String?

  family      Family   @relation(fields: [familyId], references: [id])
  kid         Kid?     @relation(fields: [kidId], references: [id])
  createdBy   User?    @relation("EventCreator", fields: [createdById], references: [id])

  tasks       Task[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Task {
  id             String      @id @default(cuid())
  familyId       String
  title          String
  description    String?
  status         TaskStatus  @default(PENDING)
  priority       TaskPriority @default(NORMAL)
  type           TaskType    @default(GENERAL)
  dueDate        DateTime?
  assigneeId     String?
  createdById    String?
  calendarEventId String?

  family         Family      @relation(fields: [familyId], references: [id])
  assignee       User?       @relation("TaskAssignee", fields: [assigneeId], references: [id])
  createdBy      User?       @relation("TaskCreator", fields: [createdById], references: [id])
  calendarEvent  CalendarEvent? @relation(fields: [calendarEventId], references: [id])

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model ShoppingItem {
  id         String          @id @default(cuid())
  familyId   String
  title      String
  category   ShoppingCategory @default(OTHER)
  quantity   Float?
  unit       String?
  isChecked  Boolean         @default(false)
  week       String?         // "2025-W03" для корзины недели
  kidId      String?
  createdById String?

  family     Family          @relation(fields: [familyId], references: [id])
  kid        Kid?            @relation(fields: [kidId], references: [id])
  createdBy  User?           @relation(fields: [createdById], references: [id])

  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
}

model HomeTask {
  id          String           @id @default(cuid())
  familyId    String
  title       String
  description String?
  area        String?          // "cleaning", "guests", "vacation", "maintenance"
  frequency   HomeTaskFrequency @default(ONE_TIME)
  nextDue     DateTime?
  lastDone    DateTime?
  isActive    Boolean          @default(true)
  assigneeId  String?

  family      Family           @relation(fields: [familyId], references: [id])
  assignee    User?            @relation("HomeTaskAssignee", fields: [assigneeId], references: [id])

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model Budget {
  id         String     @id @default(cuid())
  familyId   String
  name       String
  month      Int?       // 1-12
  year       Int?
  totalLimit Decimal?
  notes      String?

  family     Family     @relation(fields: [familyId], references: [id])
  expenses   Expense[]

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Expense {
  id          String          @id @default(cuid())
  familyId    String
  budgetId    String?
  amount      Decimal
  currency    Currency        @default(RUB)
  category    ExpenseCategory @default(OTHER)
  title       String
  description String?
  occurredAt  DateTime        @default(now())
  isRecurring Boolean         @default(false)
  kidId       String?
  createdById String?

  family      Family          @relation(fields: [familyId], references: [id])
  budget      Budget?         @relation(fields: [budgetId], references: [id])
  kid         Kid?            @relation(fields: [kidId], references: [id])
  createdBy   User?           @relation("ExpenseCreator", fields: [createdById], references: [id])

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// Доп. модели для уведомлений / устройств можно добавить позже
// (Notification, Device, AiSession и т.п.)
