# FamilyAI Backend Architecture (NestJS + Prisma + PostgreSQL)

## 1. Общий обзор

- **Тип:** монолитный backend (NestJS)
- **Язык:** TypeScript
- **ORM:** Prisma
- **БД:** PostgreSQL
- **Кэш / очереди:** Redis (сессии, rate limit, фоновые задачи, уведомления)
- **API:** REST + GraphQL (Apollo/ Mercurius)
- **AI-слой:** AI Orchestrator (интеграция с LLM-провайдерами)

Основная идея — разделение на доменные модули (Family, Kids, Calendar, Tasks, Shopping, Home, Finance, AI, Notifications), каждый со своими сущностями, сервисами и резолверами.

## 2. Высокоуровневая схема

Слои:

- **Transport layer**
  - REST-контроллеры (`@Controller`)
  - GraphQL резолверы (`@Resolver`)
- **Application / Domain layer**
  - Сервисы доменов (`*Service`)
  - Use cases (методы сервисов, оркеструющие логику)
- **Infrastructure layer**
  - Prisma client (репозитории через Prisma)
  - Интеграции: AI-провайдеры, пуш-уведомления, email/SMS
  - Redis (кэш, очереди)

Запросы от клиента:

1. **REST/GraphQL** → **AuthGuard** (JWT) → **Controller/Resolver**
2. **Controller/Resolver** → **DomainService** (CalendarService, TasksService и т.д.)
3. **DomainService** → **Prisma** (PostgreSQL) / **Redis** / **AI Orchestrator**
4. Результат возвращается клиенту.

## 3. Доменные модули

### 3.1 AuthModule
- Регистрация/логин, refresh токены.
- Соответствует сущности `User`, `Family` (создание семьи при регистрации, если нужно).

### 3.2 UsersModule
- CRUD профилей пользователей.
- Управление ролями в семье (мама, папа, бабушка и т.д.).

### 3.3 FamiliesModule
- Создание/обновление семьи.
- Приглашения в семью (инвайты).
- Настройки семьи (часовой пояс, валюта, язык, настройки AI).

### 3.4 KidsModule
- Профили детей (`Kid`).
- Медкарта, аллергии, прививки, лекарства, режим дня.

### 3.5 CalendarModule
- Сущность `CalendarEvent`.
- Семейные события, события детей, напоминания.
- Интеграция с `TasksModule` (связанные задачи).

### 3.6 TasksModule
- Сущность `Task` (общая: дом, личное, дети, работа).
- Делегирование задач членам семьи.
- Приоритеты, сроки, статусы.
- Лёгкая интеграция с `HomeTask` (как подтип/категория).

### 3.7 ShoppingModule
- Сущность `ShoppingItem`, "корзина недели".
- Категории покупок (продукты, аптека, дети, дом).
- Возможная связь с меню недели и AI подсказками.

### 3.8 HomeModule
- Сущность `HomeTask` (чек-листы, сезонные задачи, обслуживание техники).
- Повторяющиеся задачи/шаблоны.

### 3.9 FinanceModule
- Сущности `Budget` и `Expense`.
- Бюджет по категориям, регулярные платежи.
- Расходы на детей (связь с `Kid`).

### 3.10 AiModule
- Orchestrator: парсит запросы пользователей, решает, что создать/изменить (событие, задачу, покупку, расход).
- Доступ к контексту семьи (из доменных модулей).
- Логирование AI-сессий и предложений.

### 3.11 NotificationsModule
- Отправка пушей/уведомлений:
  - Напоминания о событиях, лекарствах, задачах, платежах.
- Очереди на Redis.

### 3.12 CommonModule / CoreModule
- Общие провайдеры: конфиг, PrismaService, логирование, guards, interceptors.

## 4. Безопасность и мульти-тенантность

- **Мульти-тенантность:** по `family_id` (в каждой сущности, привязанной к семье).
- **Авторизация:** JWT access/refresh, `RolesGuard` и `FamilyMemberGuard` для проверки прав.
- **Разделение доступа:** роли в семье (PARENT, CHILD, GRANDPARENT и т.п.), ограничения для детей.

## 5. Поток AI-команд

1. Пользователь пишет / говорит: «Добавь кружок плавания Маше по вторникам в 17:00».
2. Frontend → `POST /ai/command` (или `mutation aiHandleCommand`).
3. **AiModule**:
   - Обогащает контекстом семьи (дети, календарь).
   - Вызывает LLM.
   - Получает структурированный ответ (intent: `CREATE_CALENDAR_EVENT`, данные события).
4. AiModule вызывает `CalendarService.createEvent()` и, возможно, `TasksService`.
5. Возврат пользователю: созданное событие + подтверждение.

## 6. Технологические детали

- **Prisma**: генерирует типы и клиент для всех доменных сущностей.
- **Transaction boundaries:** сложные операции (например, создание события + задачи + уведомления) выполняются в транзакциях через Prisma.
- **Миграции:** `prisma migrate`.
- **Кэш:** часто читаемые данные (настройки семьи, профили детей, будущие события) могут кэшироваться в Redis.
